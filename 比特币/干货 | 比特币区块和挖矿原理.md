干货 | 比特币区块和挖矿原理
=====

译者：申屠青春　深圳大学ATR国防科技重点实验室博士

译者前言
>比特币在国内已经众所周知，但是技术研究并未有效开展，大部分人处于知道和了解程度，目前比特圈中许多人对比特币能做什么，同样了解不多。一个重要原因是大多数比特币核心资料都是英文，很少有人能静心看完如此繁杂的英文资料。本人博士论文的研究方向是比特币，在研究其英文技术的同时，拟对一些重要资料进行翻译，让更多的圈内人对比特币有更多的理解。

>本文主题是比特币区块、创世块、挖矿原理、难度等的技术资料，综合了比特币官方威客上的众多资料翻译和编写而成。


一、区块(Block)
-----
* 比特币网络中，数据以文件的形式被永久记录，我们称之为区块。一个区块是一些或所有最新比特币交易的记录集，且未被其他先前的区块记录。区块可以想像为一个城市记录者的记录本上的单独一页纸(对房地产产权的变更记录)或者是股票交易所的总帐本。在绝大多数情况下，新区块被加入到记录最后(在比特币中的名称为：块链)，一旦写上，就再也不能改变或删除。每个区块记录了它被创建之前发生的所有事件。

 * 1.1区块结构(Block Structure)

     |数据项|描述|长度|
 |----|----|----|
|Magic no魔术数|总是0xD9B4BEF9|4字节|
|Blocksize 块大小|到区块结束的字节长度|4 字节|
|Blockheader 块头|包含6个数据项|80字节|
|Transaction counter 交易数量|正整数 VI = VarInt|1–9字节|
|transactions 交易|交易列表(非空)|<Transaction counter>-许多交易|
 * 1.2详细说明(Explanation)

     + 每个区块包括一些或所有近期交易、前一个区块的引用、以及其他数据。它还包括一个挖矿难度的答案-该答案对每个区块是唯一的。新区块如果没有正确答案，不能被发送到网络中-“挖矿”的过程本质上是在竞争中 “解决”当前区块。每个区块中的数学问题难以解决，但是一旦发现了一个有效解，其他网络节点很容易验证这个解的正确性，对于给定的区块可能有多个有效解-但对于要解决的区块来说只需一个解。

     + 因为每解决一个区块，都会得到新产生的比特币奖励，每个区块包含一个记录，记录中的比特币地址是有权获得比特币奖励的地址。这个纪录被称为生产交易、或者coinbase交易，它经常是每个区块的第一个交易。每个块区生产的比特币数量是50个，每产生21万个区块后减少一半(时间大约是4年)。

     + 发送者在网络中广播比特币交易，所有试图解决区块的矿工节点，收集了这些交易记录，把它们加到矿工节点正在解决的区块中。

     + 挖矿难度由比特币网络自动调整，使之实现平均每小时解决6个区块的目标。每2016个区块(大约两周)后，所有客户端把新区块的实际数目与目标数量相比较，并且按照差异的百分比调整目标HASH值，来增加(或降低)产生区块的难度。

     + 因为所有区块包含前一个区块的引用，现存的所有区块的集合可以说是形成了一条链，然而，块链有可能产生暂时分叉-举个例子，如果两个矿工同时为一个区块产生不同的有效解，两者相互不知。P2P网络会在一段短时间内消除这些分叉，该链仅有一个分支存活。

     + 客户端接受“最长”块链作为有效链，整条块链的“长度”是指具有最大难度的链，而不是指具有最多区块数量的块链，可防止某些人创建大量低难度区块，故意使块链分叉，并且让网络接受它成为“最长”的块链。

    >(译者按：以下非标准区块内容来自https://en.bitcoin.it/wiki/Nonstandard_block ，略有改动)

   * 非标准区块：是指包括非标准交易的区块，交易的标准与否，要参考比特币客户端源代码中的IsStandard()函数。客户端不会传播非标准交易，但是某些矿池的矿工会把合法的非标准交易加入到区块中，形成非标准区块，客户端在计算难度最长的块链时，会考虑非标准区块。

    * 区块的一般问题:

     + 目前有多少个区块？

      目前的区块数，访问：http://blockexplorer.com/q/getblockcount

     + 区块的最大数量是多少？

      没有最大数量，区块以平均每10分钟一个的速度，源源不断地加到块链结尾。

     + 甚至当所有的2100万个比特币全部被挖完，还是没有最大数量吗？

      对的，区块用来确认交易在某一特定时间存在，即使比特币全部被挖完，交易还是会发生，所以只要人们还在交易比特币，区块还会被创建。

     + 我要花多少时间生成一个区块？

      没有人能够准确回答，这里有个生产计算器https://en.bitcoin.it/wiki/Generation_Calculator ，可以告诉你可能要花多少时间。

     + 如果我完成计算一个区块的1%进度…

      没有解决一个区块的1%的说法，你不会在解决区块上有任何进展，在工作24小时后，你解决一个区块的机率和24小时前一样，若非信仰比特币就是众所周知的赌徒谬误。这就像同时抛53枚硬币，使得它们人头向上，每次你试验，你的成功机率都是一样的。


二、创世块(Genesis Block)
----
  * 创世块是指块链的第一个块，现在的比特币客户端版本把块号定为0，以前的版本把该块块号定为1。

 * “2009年1月3日，首相第二次对处于崩溃边缘的银行进行紧急救助”，这句话正是泰晤士报当天的头版文章标题。这应该是一个该区块在2009年1月3日或之后创建的一个证据，同时也是对银行系统采用部分准备金制度导致不稳定性的一个说明。

 * 创世块的收益不可能被花掉，因为创世块是用代码表示的(这个巧合可能是故意的)，尽管如此，其50BTC收益还是被发送到地址：1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa。

>(译者按：创世块的收益花不掉，原因如下：比特币客户端把区块和交易分开存贮在两个数据库中，当客户端发现区块数据库为空时，用代码直接生成一个创世块，但是没有生成这个交易，所以客户端中的交易数据库中是没有发送到上述地址这个交易的，因而一旦收到要花掉该收益的交易时，都会拒绝，所以无法得到任何确认，就花不掉这50个币。出现这种情况很可能是中本聪故意的。)

三、块链(Block Chain)
----
 * 块链是所有比特币节点共享的交易数据库，这些节点基于比特币协议参与到比特币网络中来。块链包含每一个曾在比特币系统执行过的交易。根据这个信息，人们可以找到任何时候任一个地址中的币数量，

 * 每个区块包含前一个区块的HASH值，这就使得从创世块到当前块形成了一条块链，每个区块必定按时间顺序跟随在前一个区块之后，因为如果不知道前一块区块的HASH值就没法生成当前区块。要改变一个已经在块链中存在一段时间的区块，从计算上来说是不可行的，因为如果它被改变，它之后的每个区块必须随之改变。这些特性使得双花比特币非常困难，块链是比特币的最大创新。

 * 如果一个区块是最长块链的最后一个区块，诚实的矿工只会在这个区块基础生成后续块(创建新块时通过引用该块来实现)。“长度”是被计算成块链的所有联合难度，而不是区块数目，尽管这个区别仅仅在防御几个潜在攻击时有用。如果一个块链中的所有区块和交易有效，则该块链有效，并且要以创世块开头。

 * 对于块链中的任何区块来说，只有一条通向创世块的路径。然而，从创世块出发，却可能有分叉。当两个区块产生的时间仅相差几秒时，可能会产生包含一个区块的分叉。当以上现象出现时，矿工节点会根据收到区块的时间，在先收到的区块基础上继续挖矿。哪个区块的后续区块先出现，这个区块就被包括进主链，因为这条块链更长。在修正需要向后兼容的程序BUG后，出现过更严重的分叉。

 * 短块链(或有效块链)中的区块没有作用，当比特币客户端转向另一个长块链时，短块链中所有有效的交易将被重新加入到交易队列池中，将被包括中另一个块中。短块链中的区块收益不会在长链中出现，因而这些收益实际上是丢失了，这就是比特币网络强化的100个区块成熟时间的存在原因。

 * 在短块链中的区块经常被称为“孤立”区块，这是因为在长块链中的生产交易没有父区块，因而这些生产交易在交易列表的RPC调用中表现为孤立。几个矿池误解了这些信息并且把这些区块叫作“孤儿”，事实上这些区块都有父区块，可能还有子区块。

 * 因为一个区块只能引用一个父区块，因而不可能把两个已经分叉的块链合并。

>译者按：区块成熟时间(Maturation Time)，是指矿工产生一个新区块得到25BTC收益后，要等过了100个块后，才能使用这些币；这个100区块时间，即收到100个确认的时间，就是区块成熟时间。为什么要设这个时间？如果这个区块在分叉时变成了孤立区块，25个BTC的收益将消失，如果矿工挖到比特币后可以马上花掉，就会造成后续的一系列接收者损失比特币，因而设定了100个确认的限制，在这之后产生分叉的可能性非常小，即使产生分叉，也只会影响矿工收益，不会影响到其他人。

四、区块HASH算法(Block hashing Algorithm)
----
* 当挖矿时，你会经常对区块头进行HASH，你正在挖的区块也会时常更新，一个区域头包含以下数据项：

 |数据项|目的|更新时间|大小
|----|----|----|----|
|Version 版本|区域版本号|	更新软件后，它指定了一个新版本号|4|
|hashPrevBlock 前一区块的HASH|前一区块的256位HASH值|新的区块进来时|32|
|hashMerkleRootMerkele根节点HASH值|基于一个区块中所有交易的256位HASH值|接受一个交易时|32|
|Time 时间戳|从1970-01-01 00:00 UTC开始到现在，以秒为单位的当前时间戳|每几秒就更新|4|
|Bits 当前目标HASH值|压缩格式的当前目标HASH值|当挖矿难度调整时|4|
|Nonce 随机数|从0开始的32位随机|产生HASH时A (每次产生HASH随机数要增长)|4|

* 区块内包含许多交易，它们通过Merkle根节点间接被HASH，因为所有交易不可能直接被HASH，HASH包含一个交易的区块所花的时间，和HASH包含1万个交易的区块一样。

* 目标HASH值的压缩格式是一个特殊的浮点编码类型，首字节是指数(仅使用了5个最低位)，后3个字节是尾数，它能表示256位的数值。一个区块头的SHA256值必定要小于或等于目标HASH值，该区块才能被网络所接受，目标HASH越低，产生一个新区块的难度越大。

* 上述大部分数据项对所有用户是一致的，可能在时间戳上有些区别。如果当前区块的时间戳大于前11个区块的的平均时间戳，并且小于“网络调整时间(Network-Adjusted Time)”+2小时，则认为该时间戳是有效的。其中的“网络调整时间”是指与你相连接的所有节点的平均时间。当节点A连接到节点B时，A从B处得到一个UTC标准的时间戳，A先转换成本地UTC标准时间保存起来，网络调整时间等于所有节点的本地UTC时间+所有相连节点的偏移量平均值，然而，该网络时间永远不会调整到超过本地系统时间70分钟以上。

* Nonce随机数通常不同，但是它以严格的线性方式增长，从0开始，每次HASH时都会增长，当Nonce溢出时(此事经常发生)，生产交易的extraNonce项会增长，将改变Merkle树的根节点。

* 假定针对这些数据项，人们经常会独自产生同样序列号的HASH值，最快的CPU通常会赢。然而，两人产生同样的Merkle根节点基本是(或近似)不可能的，因为区块中的第一个交易是生产交易并且“发送”到你的独一无二的比特币地址。因为你的区块与其他人的区块不同，产生的HASH也肯定(近似肯定)不同，你计算的每个HASH和网络中的其他人一样，都有同样的获胜机会。

* 比特币使用：SHA256(SHA256(区块头))计算HASH，但你要注意字节序。

* 注意：实际的HASH值是一串256位的数值，首部有许多零。当以大头端十六进制常数方式打印或存贮时，它的首部有许多零；如果它以小头端打印或存贮，零就会变换到尾部。例如：如果表示成字节串-最低(或者开头)的字节串地址显示最小位的数，这样就是小头端表示。blockexplorer的输出把HASH值显示为大头端表示的数值，因为数字的表示通常是-首部数字是最大数字，从左向右读。

五、难度(Difficulty)
----
 * 难度是对挖矿困难程度的度量，即指：计算符合给定目标的一个HASH值的困难程度。比特币网络有一个全局的区块难度，有效的区域必须有一个HASH值，该HASH值必须小于给定的目标HASH。矿池也会有一个自定义的共享难度用来设定产生股份的最低难度限制。

* 难度每过2016块改变一次，计算公式：difficulty = difficulty_1_target / current_target。目标(target)是一个256位长的数值。

* 有许多不同测量难度的方法，得到的difficulty_1_target可能不同。传统地，它表示一个HASH值，前32位为0，后续部分为1(称之为：矿池难度或pdiff)，比特币协议把目标HASH表示成一个固定精度的自定义浮点类型，因而，比特币客户端用该值来估计难度(称之为：bdiff)。

* 难度经常被存贮在区块中，每个块存贮一个十六制的目标HASH的压缩表达式(称之为：Bits)，目标HASH可以以预先定义的公式计算出来。

* 目前难度可以通过http://blockexplorer.com/q/getdifficulty来得到，下一个难度可以通过http://blockexplorer.com/q/estimate 来获得。难度的变化情况可以查看http://bitcoin.sipa.be/。

* 最大难度大约=maximum_target / 1 (因为0会导致无穷大)，这是一个非常大的数值，大约2^224；当maximum_target为最小1时，最小难度值为1。

* 难度根据以前2016个区块的产生时间，每2016块改变一次。预计每隔10分钟产生一个区块，因而产生2016个区块要花费2周时间。如果前2016个区块的产生时间多于两周，则难度会降低；否则难度就会增加。


* 挖矿硬件对比 https://en.bitcoin.it/wiki/Mining_hardware_comparison，可以帮助预测收入。

* 收支计算器http://www.vnbitcoin.org/bitcoincalculator.php 能帮你计算收支。

**记住：这只是可能性，并不能保证你每天都能找到新区块。建议加入矿池挖矿，通过共享区块收益的方式，能得到稳定长期的回报。**

######本文译自比特币WIKI：https://en.bitcoin.it/wiki/Block_chain，https://en.bitcoin.it/wiki/Block ，https://en.bitcoin.it/wiki/Block_hashing_algorithm，https://en.bitcoin.it/wiki/Genesis_block， https://en.bitcoin.it/wiki/Nonstandard_block ，https://en.bitcoin.it/wiki/Difficulty ，https://en.bitcoin.it/wiki/Target


